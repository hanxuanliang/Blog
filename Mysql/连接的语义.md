# 连接的原理

我们在查询的时候一般都绕不开一个概念就是`join`，也就是`连接`。我在学习的时候，理解了连接的语义之后却不明白各个表中的记录到底是怎么连起来的，以至于在使用的时候总是陷入误区。

- 复杂的查询一个连接连到尾
- 慢查询就是因为使用了连接

所以这篇文章就是讲一下这个平时一直使用却不知道为什么的东西。

## 连接简介

> 此篇文章使用的工具是 [**mycli**](<https://github.com/dbcli/mycli>) ，十分推荐使用。`Mysql` 系列的文章都使用这个工具。

### 语义介绍

首先先创建数据库和表吧

```mysql
CREATE DATABASE study_mysql_test;
CREATE TABLE t1 (m1 int, n1 char(1));
CREATE TABLE t2 (m2 int, n2 char(1));

INSERT INTO t1 VALUES(1, 'a'), (2, 'b'), (3, 'c');
INSERT INTO t2 VALUES(2, 'b'), (3, 'c'), (4, 'd');
```

另外插播一句：查看`MySql`数据库物理文件存放位置：

```mysql
mysql root@localhost:study_mysql_test> show global variables like "%datadir%";
+---------------+---------------------------------------------+
| Variable_name | Value                                       |
+---------------+---------------------------------------------+
| datadir       | C:\ProgramData\MySQL\MySQL Server 5.7\Data\ |
+---------------+---------------------------------------------+
1 row in set
Time: 0.024s
// 这个是我的机器上的位置，可能你的就不是。
```

我们成功建立了`t1`、`t2`两个表，这两个表都有两个列，一个是`INT`类型的，一个是`CHAR(1)`类型的，填充好数据的两个表长这样：

```mysql
mysql root@localhost:study_mysql_test> select * from t1;
+----+----+
| m1 | n1 |
+----+----+
| 1  | a  |
| 2  | b  |
| 3  | c  |
+----+----+
3 rows in set
Time: 0.018s
mysql root@localhost:study_mysql_test> select * from t2;
+----+----+
| m2 | n2 |
+----+----+
| 2  | b  |
| 3  | c  |
| 4  | d  |
+----+----+
3 rows in set
Time: 0.017s
```

`连接`的本质就是把各个连接表中的记录都取出来依次匹配的组合加入结果集并返回给用户。

![连接的本质](<https://github.com/hanxuanliang/Blog/blob/master/Pic/连接的本质.jpg>)

这个过程看起来就是把`t1`表的记录和`t2`的记录连起来组成新的更大的记录，所以这个查询过程称之为`连接查询`。`连接查询`的结果集就是 `一个表的每一条记录与另一个表的每一条记录相互匹配的组合` ，而这种结果集就是 `笛卡尔积`  。因为表`t1`中有3条记录，表`t2`中也有3条记录，所以这两个表连接之后的笛卡尔积就有`3×3=9`行记录。而在`Mysql`里面，连接查询的语法很随意，只要在 `From`后面跟多个表名就好了，例如这个：

```mysql
³³³³mysql root@localhost:study_mysql_test> select * from t1, t2;
+----+----+----+----+                                       
| m1 | n1 | m2 | n2 |                                       
+----+----+----+----+                                       
| 1  | a  | 2  | b  |                                       
| 2  | b  | 2  | b  |                                       
| 3  | c  | 2  | b  |                                       
| 1  | a  | 3  | c  |                                       
| 2  | b  | 3  | c  |                                       
| 3  | c  | 3  | c  |                                       
| 1  | a  | 4  | d  |                                       
| 2  | b  | 4  | d  |                                       
| 3  | c  | 4  | d  |                                       
+----+----+----+----+                                       
9 rows in set                                               
Time: 0.036s                                                
```

### 过程简介

从上面我们看到，如果我们没有任何限制连接任意数量的表（如果你乐意这么干的话），这些表连接起来产生的 `笛卡尔积` 是非常巨大的 。比如 `3个表，每个表100行记录` 连接的结果就是 `100×100×100=1000000`行数据 ！ 如此庞大的数据展示，第一是对`Mysql`的压力，二是我们自己不一定需要全部结果。所以在连接的过程中过滤记录组合是十分有必要的。在 `连接查询`中的过滤条件分为两种：

-  单表条件

  比如`t1.m1 > 1`是只针对`t1`表的过滤条件，`t2.n2 < 'd'`是只针对`t2`表的过滤条件。

- 多表条件

  比如`t1.m1 = t2.m2`、`t1.n1 > t2.n2`，这些条件中涉及到了两个表。

下边我们就要看一下携带过滤条件的连接查询的大致执行过程，比方说下边这个查询语句：

```mysql
mysql root@localhost:study_mysql_test> SELECT * FROM t1, t2 WHERE t1.m1 > 1 AND t1.m1 = t2.m2 AND t2.n2 < 'd';                             
+----+----+----+----+                                                                    
| m1 | n1 | m2 | n2 |                                                                    
+----+----+----+----+                                                                    
| 2  | b  | 2  | b  |                                                                    
| 3  | c  | 3  | c  |                                                                    
+----+----+----+----+                                                                    
2 rows in set                                                                            
Time: 0.034s                                                                             
```

下边我们就要看一下携带过滤条件的连接查询的大致执行过程了，比方说下边这个查询语句：

```mysql
SELECT * FROM t1, t2 WHERE t1.m1 > 1 AND t1.m1 = t2.m2 AND t2.n2 < 'd';
```

在这个查询中我们指明了这三个过滤条件：

- `t1.m1 > 1`
- `t1.m1 = t2.m2`
- `t2.n2 < 'd'`

那么这个连接查询的大致执行过程如下：

1. 先确定

